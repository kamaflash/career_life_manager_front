<!-- form-dynamic.component.html -->
<form
  [formGroup]="form"
  (ngSubmit)="onSubmit()"
  class="space-y-6 animate-fade-in"
>
  <!-- Barra de progreso -->
  <div
    *ngIf="config.showProgress && config.currentStep && config.totalSteps"
    class="mb-6"
  >
    <div class="flex justify-between text-sm mb-2">
      <span class="text-gray-400">
        Paso {{ config.currentStep }} de {{ config.totalSteps }}
      </span>
      <span class="text-blue-400 progress-percentage">
        {{ getProgressPercentage() }}% completado
      </span>
    </div>
    <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
      <div
        class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500 progress-bar"
        [style.width.%]="getProgressPercentage()"
      ></div>
    </div>
  </div>

  <!-- Secciones del formulario -->
  <ng-container
    *ngFor="let section of config.sections; let sectionIndex = index"
  >
    <!-- Encabezado de secci√≥n -->
    <div *ngIf="section.title" class="mb-6">
      <h3 class="text-lg font-bold mb-2 flex items-center gap-2 text-gray-100">
        <span *ngIf="section.icon" class="text-xl">{{ section.icon }}</span>
        {{ section.title }}
      </h3>
      <p *ngIf="section.description" class="text-sm text-gray-400">
        {{ section.description }}
      </p>
    </div>

    <!-- Grid de campos -->
    <div
      *ngIf="!section.fullWidth"
      class="grid gap-4"
      [class.grid-cols-1]="config.columns === 1"
      [class.grid-cols-2]="config.columns === 2"
      [class.grid-cols-3]="config.columns === 3"
    >
      <ng-container *ngFor="let field of getVisibleFields(section.fields)">
        <!-- Campo de texto/email/number/password -->
        <div
          *ngIf="['text', 'email', 'number', 'password'].includes(field.type)"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <label class="block text-sm font-medium text-gray-300 mb-2">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-400">*</span>
          </label>

          <div class="relative">
            <input
              [type]="getInputType(field)"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [attr.min]="field.min"
              [attr.max]="field.max"
              class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 pl-11 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
              [class.border-red-500]="isFieldInvalid(field.name)"
              [class.opacity-50]="isFieldDisabled(field.name)"
              (input)="onFieldChange(field)"
            />
            <span *ngIf="field.icon" class="absolute left-3 top-3 text-lg">
              {{ field.icon }}
            </span>
          </div>

          <!-- Indicador de fortaleza de contrase√±a -->
          <div
            *ngIf="field.type === 'password' && field.showStrength"
            class="mt-2"
          >
            <div class="flex items-center gap-1 mb-1">
              <div
                *ngFor="let bar of [1, 2, 3, 4]; let i = index"
                class="flex-1 h-2 rounded-full transition-all duration-300 strength-bar"
                [ngClass]="getStrengthBarClass(i)"
              ></div>
            </div>
            <div
              class="text-xs strength-text"
              [ngClass]="passwordStrength.color"
            >
              {{ passwordStrength.text }}
            </div>
          </div>

          <!-- Mensajes de error -->
          <div
            *ngIf="showFieldError(field.name)"
            class="mt-1 text-xs text-red-400"
          >
            <span *ngIf="form.get(field.name)?.errors?.['required']">
              Este campo es requerido
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['email']">
              Email inv√°lido
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['min']">
              M√≠nimo {{ field.min }}
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['max']">
              M√°ximo {{ field.max }}
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['minlength']">
              M√≠nimo {{ field.min }} caracteres
            </span>
          </div>
        </div>

        <!-- Select -->
        <div
          *ngIf="field.type === 'select'"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <label class="block text-sm font-medium text-gray-300 mb-2">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-400">*</span>
          </label>

          <div class="relative">
            <select
              [formControlName]="field.name"
              class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 pl-11 text-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 appearance-none"
              [class.border-red-500]="isFieldInvalid(field.name)"
              [class.opacity-50]="isFieldDisabled(field.name)"
              (change)="onFieldChange(field)"
            >
              <option value="" disabled selected class="text-gray-500">
                {{ field.placeholder || "Seleccionar..." }}
              </option>
              <option
                *ngFor="let option of field.options || []"
                [value]="option.value"
                class="text-white bg-gray-800"
              >
                <span *ngIf="option.icon" class="mr-2">{{ option.icon }}</span>
                {{ option.label }}
              </option>
            </select>
            <span *ngIf="field.icon" class="absolute left-3 top-3 text-lg">
              {{ field.icon }}
            </span>
            <span class="absolute right-3 top-3 text-gray-400">‚ñº</span>
          </div>

          <!-- Mensajes de error -->
          <div
            *ngIf="showFieldError(field.name)"
            class="mt-1 text-xs text-red-400"
          >
            <span *ngIf="form.get(field.name)?.errors?.['required']">
              Este campo es requerido
            </span>
          </div>
        </div>

        <!-- Textarea -->
        <div
          *ngIf="field.type === 'textarea'"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <label class="block text-sm font-medium text-gray-300 mb-2">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-400">*</span>
          </label>

          <div class="relative">
            <textarea
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              rows="3"
              class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all resize-none"
              [class.border-red-500]="isFieldInvalid(field.name)"
              [class.opacity-50]="isFieldDisabled(field.name)"
              (input)="onFieldChange(field)"
            ></textarea>
          </div>

          <!-- Mensajes de error -->
          <div
            *ngIf="showFieldError(field.name)"
            class="mt-1 text-xs text-red-400"
          >
            <span *ngIf="form.get(field.name)?.errors?.['required']">
              Este campo es requerido
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['minlength']">
              M√≠nimo {{ field.min }} caracteres
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['maxlength']">
              M√°ximo {{ field.max }} caracteres
            </span>
          </div>
        </div>

        <!-- Selector de dificultad (botones) -->
        <div
          *ngIf="field.type === 'difficulty-selector'"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <label class="block text-sm font-medium text-gray-300 mb-2">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-400">*</span>
          </label>

          <div class="grid grid-cols-3 gap-2">
            <button
              *ngFor="let button of field.buttons || []"
              type="button"
              class="difficulty-btn p-3 rounded-xl text-center transition-all duration-300 hover:scale-105"
              [class.active]="form.get(field.name)?.value === button.value"
              [class.bg-gradient-to-r]="
                form.get(field.name)?.value === button.value
              "
              [class.from-emerald-500]="
                form.get(field.name)?.value === button.value
              "
              [class.to-emerald-600]="
                form.get(field.name)?.value === button.value
              "
              [class.border-emerald-500]="
                form.get(field.name)?.value === button.value
              "
              [class.bg-gray-800]="form.get(field.name)?.value !== button.value"
              [class.border-gray-700]="
                form.get(field.name)?.value !== button.value
              "
              [disabled]="isFieldDisabled(field.name)"
              (click)="selectDifficulty(field.name, button.value)"
            >
              <div class="text-lg mb-1">{{ button.icon || "üéÆ" }}</div>
              <div class="font-medium text-white">{{ button.label }}</div>
              <div
                *ngIf="button.description"
                class="text-xs text-gray-400 mt-1"
              >
                {{ button.description }}
              </div>
            </button>
          </div>
        </div>
        <!-- Campo de fecha -->
        <div
          *ngIf="field.type === 'date'"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <label class="block text-sm font-medium text-gray-300 mb-2">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-400">*</span>
          </label>

          <div class="relative">
            <input
              type="date"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || 'Selecciona una fecha'"
              [min]="field.minDate"
              [max]="field.maxDate"
              class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 pl-11 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all datepicker"
              [class.border-red-500]="isFieldInvalid(field.name)"
              [class.opacity-50]="isFieldDisabled(field.name)"
              (change)="onFieldChange(field)"
            />
            <span class="absolute left-3 top-3 text-lg"> üìÖ </span>
          </div>

          <!-- Mensajes de error -->
          <div
            *ngIf="showFieldError(field.name)"
            class="mt-1 text-xs text-red-400"
          >
            <span *ngIf="form.get(field.name)?.errors?.['required']">
              Este campo es requerido
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['min']">
              La fecha no puede ser anterior a
              {{ field.minDate | date: "dd/MM/yyyy" }}
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['max']">
              La fecha no puede ser posterior a
              {{ field.maxDate | date: "dd/MM/yyyy" }}
            </span>
          </div>
        </div>
        <!-- Checkbox simple -->
        <div
          *ngIf="field.type === 'checkbox-simple'"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              [id]="'checkbox-' + field.name"
              [formControlName]="field.name"
              class="mt-1 w-5 h-5 bg-gray-900/50 border border-gray-700 rounded focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
              [class.checked]="form.get(field.name)?.value"
            />
            <label
              [for]="'checkbox-' + field.name"
              class="text-sm text-gray-300 leading-relaxed cursor-pointer"
            >
              {{ field.label }}
              <span *ngIf="field.required" class="text-red-400">*</span>
            </label>
          </div>
        </div>
        <!-- Campo checkbox-group - Versi√≥n mejorada -->
        <div
          *ngIf="field.type === 'checkbox-group'"
          [ngClass]="getFieldContainerClasses(field)"
        >
          <label class="block text-sm font-medium text-gray-300 mb-2">
            {{ field.label }}
            <span *ngIf="field.required" class="text-red-400">*</span>
            <span
              *ngIf="field.description"
              class="block text-xs text-gray-400 mt-1"
            >
              {{ field.description }}
            </span>
          </label>

          <!-- Grid de checkboxes compactos -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div *ngFor="let option of field.options" class="relative">
              <input
                type="checkbox"
                [id]="'checkbox-' + field.name + '-' + option.value"
                [checked]="isOptionChecked(field.name, option.value)"
                (change)="toggleCheckbox(field, option.value)"
                [disabled]="isCheckboxDisabled(field, option.value)"
                class="sr-only peer"
              />
              <label
                [for]="'checkbox-' + field.name + '-' + option.value"
                class="flex items-center justify-between p-3 bg-gray-800/40 border border-gray-700 rounded-xl cursor-pointer transition-all duration-200 peer-checked:bg-blue-500/10 peer-checked:border-blue-500/40 peer-checked:shadow-sm peer-checked:shadow-blue-500/20 hover:bg-gray-700/40 hover:border-gray-600 peer-disabled:opacity-40 peer-disabled:cursor-not-allowed peer-disabled:hover:bg-gray-800/40"
              >
                <div class="flex items-center gap-3">
                  <!-- Checkbox visual personalizado -->
                  <div
                    class="flex-shrink-0 w-5 h-5 flex items-center justify-center border-2 border-gray-600 rounded-md peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white transition-all duration-200"
                  >
                    <svg
                      *ngIf="isOptionChecked(field.name, option.value)"
                      class="w-3 h-3"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="3"
                        d="M5 13l4 4L19 7"
                      ></path>
                    </svg>
                  </div>

                  <!-- Contenido de la opci√≥n -->
                  <div class="flex flex-col">
                    <span
                      class="text-sm font-medium text-gray-200 peer-checked:text-blue-300"
                    >
                      {{ option.label }}
                    </span>
                    <span
                      *ngIf="option.description"
                      class="text-xs text-gray-400 mt-0.5"
                    >
                      {{ option.description }}
                    </span>
                  </div>
                </div>

                <!-- √çcono opcional -->
                <span
                  *ngIf="option.icon"
                  class="text-lg ml-2 text-gray-400 peer-checked:text-blue-400"
                >
                  {{ option.icon }}
                </span>
              </label>
            </div>
          </div>

          <!-- Contador y acciones -->
          <div
            *ngIf="field.maxSelections"
            class="flex items-center justify-between mt-3 px-1"
          >
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-400">
                <span class="font-medium text-blue-400">{{
                  getSelectedCount(field.name)
                }}</span
                >/{{ field.maxSelections }}
              </span>
              <div
                *ngIf="getSelectedCount(field.name) >= field.maxSelections"
                class="flex items-center gap-1 text-xs text-amber-400"
              >
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span>L√≠mite alcanzado</span>
              </div>
            </div>

            <button
              *ngIf="getSelectedCount(field.name) > 0"
              type="button"
              class="text-xs text-gray-400 hover:text-gray-300 transition-colors flex items-center gap-1"
              (click)="clearCheckboxes(field.name)"
            >
              <svg
                class="w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              Limpiar
            </button>
          </div>

          <!-- Mensajes de error -->
          <div
            *ngIf="showFieldError(field.name)"
            class="mt-2 text-xs text-red-400"
          >
            <span *ngIf="form.get(field.name)?.errors?.['required']">
              Debe seleccionar al menos una opci√≥n
            </span>
            <span *ngIf="form.get(field.name)?.errors?.['maxSelections']">
              M√°ximo {{ field.maxSelections }} opciones permitidas
            </span>
          </div>
        </div>
        <!-- Bot√≥n de submit -->
        <div
          *ngIf="field.type === 'submit-button'"
          [class.col-span-2]="config.columns === 2"
          [class.col-span-3]="config.columns === 3"
          class="w-full"
        >
          <button
            type="submit"
            [disabled]="form.invalid || isLoading"
            (click)="onSubmit()"
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="flex items-center justify-center gap-2">
              <span *ngIf="isLoading" class="loading-spinner">
                <svg
                  class="animate-spin h-5 w-5 text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </span>
              <span *ngIf="!isLoading && field.icon" class="text-lg">{{
                field.icon
              }}</span>
              <span>{{ field.label }}</span>
            </span>
          </button>
        </div>

        <!-- Bot√≥n de enlace -->
        <div
          *ngIf="field.type === 'link-button'"
          [class.col-span-2]="config.columns === 2"
          [class.col-span-3]="config.columns === 3"
          class="w-full text-center"
        >
          <span class="text-gray-400 text-sm">{{ field.label }}</span>
          <button
            type="button"
            class="text-blue-400 hover:text-blue-300 text-sm font-medium ml-2 hover:underline transition-colors"
            (click)="onLinkClick(field)"
          >
            {{ field.placeholder || "Haz clic aqu√≠" }} ‚Üí
          </button>
        </div>
      </ng-container>
    </div>

    <!-- Layout de ancho completo para toda la secci√≥n -->
    <div *ngIf="section.fullWidth" class="space-y-4">
      <ng-container *ngFor="let field of getVisibleFields(section.fields)">
        <!-- Renderizar los mismos campos pero sin grid -->
        <!-- Se repite la misma l√≥gica de campos pero sin las clases de grid -->
        <!-- Por brevedad, aqu√≠ solo muestro un ejemplo simplificado -->
        <div class="w-full">
          <!-- Los campos aqu√≠ se renderizar√°n en ancho completo -->
          <!-- Podr√≠as usar un ngSwitch para renderizar cada tipo -->
        </div>
      </ng-container>
    </div>
  </ng-container>

  <!-- Login social -->
  <div
    *ngIf="config.showSocialLogin"
    class="mt-8 pt-6 border-t border-gray-700/50"
  >
    <p class="text-center text-gray-400 text-sm mb-4">
      O entra r√°pidamente con
    </p>
    <div class="grid grid-cols-3 gap-3 text-gray-100">
      <button
        type="button"
        class="social-btn p-3 bg-gray-800/50 border border-gray-700 rounded-xl hover:bg-gray-700/50 transition-colors duration-200"
        (click)="onSocialLogin('google')"
      >
        <span class="flex items-center justify-center gap-2">
          <span>üîµ</span>
          <span class="text-sm">Google</span>
        </span>
      </button>

      <button
        type="button"
        class="social-btn p-3 bg-gray-800/50 border border-gray-700 rounded-xl hover:bg-gray-700/50 transition-colors duration-200"
        (click)="onSocialLogin('linkedin')"
      >
        <span class="flex items-center justify-center gap-2">
          <span>üíº</span>
          <span class="text-sm">LinkedIn</span>
        </span>
      </button>

      <button
        type="button"
        class="social-btn p-3 bg-gray-800/50 border border-gray-700 rounded-xl hover:bg-gray-700/50 transition-colors duration-200"
        (click)="onSocialLogin('github')"
      >
        <span class="flex items-center justify-center gap-2">
          <span>üêô</span>
          <span class="text-sm">GitHub</span>
        </span>
      </button>
    </div>
    <p class="text-center text-gray-400 text-sm mt-4" *ngIf="isRegister">
      Ya tengo cuenta.
      <a
        routerLink="/login"
        class="text-blue-400 hover:text-blue-500 cursor-pointer"
        >Entrar</a
      >
    </p>
    <p class="text-center text-gray-400 text-sm mt-4" *ngIf="isLogin">
      A√∫n no tengo cuenta.
      <a
        routerLink="/login"
        class="text-blue-400 hover:text-blue-500 cursor-pointer"
        >Crear cuenta</a
      >
    </p>
  </div>
</form>
